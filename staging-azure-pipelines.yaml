# trigger:
#   branches:
#     include:
#       - develop

#  Use pipeline run button (manual UI or API)
pr: none
trigger: none  #  Explicitly disables automatic CI triggers

variables:
- group: ovh-secrets
- name: imageName
  value: dtma/frontend
- name: imageTag
  value: $(Build.BuildId)

steps:
# 1. Referencing Github Repo
- checkout: self

# 2. Authenticating and Pulling Frontend Image from the Registry.
- script: |
    kubectl create secret docker-registry regcred \
              	--docker-server=$REGISTRY_URL \
              	--docker-username=$REGISTRY_USERNAME \
              	--docker-password=$REGISTRY_PASSWORD \
              	--docker-email=$REGISTRY_EMAIL \
              	--namespace=test
              

    echo "Updating deployment with image tag: $(imageTag)"
    sed -i "s|image: .*$|image: $(REGISTRY_URL)/dtma/$(imageName):$(imageTag)|" K8s/overlays/staging/deployment.yaml

  displayName: "Authenticating and Pulling Frontend Image from the Registrys"

 # Fetch latest image tag from OVH CCR and update deployment manifest
- script: |
      echo "Installing jq and yq..."
      sudo apt-get update
      sudo apt-get install -y jq yq
      
      echo "Fetching latest image tag from OVH CCR..."
      LATEST_TAG=$(curl -s -u "$(REGISTRY_USERNAME):$(REGISTRY_PASSWORD)" \
        https://$(REGISTRY_URL)/v2/dtma/$(imageName)/tags/list \
        | jq -r '.tags | sort | last')

      echo "Latest tag: $LATEST_TAG"

      echo "Patching deployment manifest..."
      yq e -i '.spec.template.spec.containers[0].image = "$(REGISTRY_URL)/dtma/$(imageName):" + env(LATEST_TAG)' \
        k8s/overlays/staging/deployment.yaml
  displayName: "Update image tag in manifest"
# 3. Download the Kubeconfig File from Azure DevOps Secure Files
- task: DownloadSecureFile@1
  displayName: 'GetKubeconfig'
  name: GetKubeconfig
  inputs:
    secureFile: 'kubeconfig-dtma.yml'  # Use the name of your Kubeconfig secure file in Azure DevOps
  
#4. Authenticating Kubernetes.'
- script: |
      echo "Authenticating Kubernetes"
      mkdir -p ~/.kube
      cp $KUBECONFIG_FILE ~/.kube/config 
      kubectl config use-context kubernetes-admin@DTMA
      kubectl config get-contexts

  env:
    KUBECONFIG_FILE: $(GetKubeconfig.secureFilePath)
  displayName: 'Authenticating Kubernetes'

# 5. Deploying Image to OVH
- task: Kubernetes@1
  displayName: 'Deploy to OVH Kubernetes Cluster'
  inputs:
    connectionType: 'Kubernetes service connection'
    kubernetesServiceEndpoint: 'Kubernetes-dtma'  # Use your secure file path or environment variable
    command: 'apply'
    arguments: '-k K8s/overlays/staging'
    # Optional: Add namespace if needed (default or specify another)
    namespace: 'test'

# 6. Verifying Deployment Success
- script: |
      echo "‚úÖ Waiting for deployment to finish..."
      kubectl rollout status deployment/dtma-frontend -n test --timeout=180s

      echo "üîç Checking for non-running pods..."
      NOT_RUNNING=$(kubectl get pods -n test --selector=app=frontend \
        --no-headers | grep -v "Running" || true)

      if [ -n "$NOT_RUNNING" ]; then
        echo "‚ùå Some pods are not running:"
        echo "$NOT_RUNNING"
        exit 1
      else
        echo "‚úÖ All pods are running."
      fi
  displayName: "Verifying deployment success"